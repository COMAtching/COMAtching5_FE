name: Gemini Code Review

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # [중요] 구형 'google-generativeai'가 아닌 신형 'google-genai' 설치
          pip install google-genai

      - name: Run Gemini Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python -c "
          import os
          import subprocess
          # [중요] 최신 SDK import 방식
          from google import genai 

          try:
              # 1. 클라이언트 초기화
              client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

              # 2. Git Diff 가져오기
              base_ref = os.environ.get('GITHUB_BASE_REF', 'main')
              subprocess.run(['git', 'fetch', 'origin', base_ref], check=True)
              diff_process = subprocess.run(['git', 'diff', f'origin/{base_ref}'], capture_output=True, text=True)
              diff_content = diff_process.stdout

              if not diff_content:
                  print('변경 사항이 없습니다.')
                  exit(0)

              # 3. 프롬프트 작성
              prompt = f'''
              당신은 프론트엔드 리드 개발자입니다. 아래 코드를 리뷰하세요.
              
              [리뷰 중점 사항]
              1. 버그 및 런타임 에러 가능성
              2. React/Next.js 안티 패턴 여부
              3. 코드 가독성 및 스타일 가이드 준수 여부
              4. 한국어로 정중하게 작성할 것

              [Code Diff]
              {diff_content[:30000]}
              '''

              # 4. Gemini 요청 (가장 안정적인 1.5 Flash 모델 사용)
              # 주의: Pro 모델은 404 에러가 날 수 있으므로 Flash 사용 권장
              response = client.models.generate_content(
                  model='gemini-1.5-flash', 
                  contents=prompt
              )
              
              review_comment = response.text
              
              with open('review_comment.txt', 'w', encoding='utf-8') as f:
                  f.write(review_comment)
              
          except Exception as e:
              print(f'Critical Error: {e}')
              exit(1)
          "

      - name: Post Comment on PR
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file review_comment.txt
